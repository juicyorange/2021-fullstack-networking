## 09-10. ZMQ DEALER ROUTER PATTERN

<br>

### κ°λ° κ²°κ³Όλ¬Ό

- node.jsμ `zeromq` λ¨λ“μ„ μ‚¬μ©ν•μ—¬ zmqλ¥Ό μ‚¬μ©ν•΄λ³Έλ‹¤.

- ν΄λΌμ΄μ–ΈνΈ ν”„λ΅κ·Έλ¨μ—μ„ μ”μ²­μ„ `dealer`λ¥Ό ν†µν•΄ μ”μ²­μ„ λ³΄λ‚΄λ©΄, μ„λ²„μ `router`κ°€ μ΄λ¥Ό λ°›κ³ , λ‹¤μ‹ μ„λ²„μ `dealer`κ°€ μ„λ²„ λ’¤μ— μκ±°λ‚, μ„λ²„μ™€ κ°™μ΄ μ΅΄μ¬ν•λ” μ›μ»¤λ“¤μ `dealer`μ—κ² μΌμ„ λ³΄λ‚΄κ³ , μ‘μ—…μ„ λ§μΉλ©΄ λ‹¤μ‹ λ°λ€λ΅ ν΄λΌμ΄μ–ΈνΈκΉμ§€ λμ•„μ¤λ” ν”„λ΅κ·Έλ¨μ„ λ§λ“¤μ–΄λ³Έλ‹¤.

    <img src="./1.png" alt="drawing" width="500"/>

- μ΄λ• μ„λ²„ λ’¤μ μ—¬λ¬κ°μ μ›μ»¤λ“¤μ„ λ™μ‘μ‹ν‚¤κΈ° μ„ν•΄ λ©€ν‹° ν”„λ΅μ„Έμ‹±μ„ μ΄μ©ν•λ‹¤.

- λ©€ν‹° ν”„λ΅μ„Έμ‹±μ„ μ΄μ©ν•λ” μ΄μ  :

  - [μ¤νƒ μ¤λ²„ν”λ΅μ° μ°Έμ΅°λ¬Έμ„](https://stackoverflow.com/questions/40028377/is-it-possible-to-achieve-multithreading-in-nodejs)
  - Node.js λ” μμ²΄μ μΌλ΅ λΉ„λ™κΈ°μ²λ¦¬λ¥Ό μ§€μ›ν•κΈ° λ•λ¬Έμ— multithreadλ΅ λ™μ‘ν•λ” κ²ƒκ³Ό λ™μΌν•λ‹¤ λ³Ό μ μλ‹¤.
  - Node.js μ κ·Όκ°„μΈ JavaScript λ” μ‹¤μ§μ μΈ λ©μ μ„ μ„ν•΄ λ‹¨μΌ μ“°λ λ“μ—μ„ λ™μ‘ν•κ²λλ‹¤. λ”°λΌμ„ λ©€ν‹° μ“°λ λ“λ¥Ό κµ¬ν„ν•κ³  μ‹¶λ‹¤λ©΄ κ²°κµ­μ—λ” λ©€ν‹° ν”„λ΅μ„Έμ¤λ¥Ό κµ¬ν„μ„ ν•΄μ•Όν•λ‹¤.
  - κ·Έ κ²°κ³Ό μ“°λ λ“λ¥Ό λ§λ“¤κΈ° μ„ν•΄ ν”„λ΅μ„Έμ¤λ¥Ό ν•λ‚ λ” λ§λ“¤κΈ° λ•λ¬Έμ—, λ‹¤λ¥Έ ν”„λ΅κ·Έλλ° μ–Έμ–΄μ—μ„ μ“°λ λ“λ¥Ό λ§λ“λ” κ²ƒ λ³΄λ‹¤ ν¨μ¨μ„±μ΄ λ–¨μ–΄μ§ μ μλ‹¤.

- μ΄λ• μ„λ²„μ `dealer` λ” μ—°κ²°λ μ›μ»¤μ μλ¥Ό ν™•μΈν•κ³ , λ“¤μ–΄μ¨ μΌμ„ μ΄λ“¤μ—κ² κ³µν‰ν•κ² λ‚λ„μ–΄μ£Όλ” κ²ƒμ„ ν”„λ΅κ·Έλ¨μ—μ„ ν™•μΈν•  μ μλ‹¤.

  - μ΄κ²ƒμ΄ λ‚΄λ¶€μ μΌλ΅ κµ¬ν„λμ–΄μμ–΄ μ‚¬μ©μλ” μΌμ„ λ¶„λ°°ν•λ” κ²ƒμ„ κµ¬ν„ν•  ν•„μ”μ—†μ΄, κ·Έλƒ¥ μ‚¬μ©λ§ ν•λ©΄ λλ‹¤λ” κ²ƒμ΄ ν° μ¥μ μ΄λ‹¤.

- κ³µμ‹ ν™νμ΄μ§€μ— μ μ‹λμ–΄μλ” μ—¬λ¬ ν¨ν„΄λ“¤ μ¤‘ dealer-router ν¨ν„΄μ„ μ‚¬μ©ν•λ‹¤.
  ([zmq κ³µμ‹ λ¬Έμ„](https://zguide.zeromq.org/docs/chapter3/#The-Asynchronous-Client-Server-Pattern))

<br>

### μ†μ¤μ½”λ“ μ†κ°

π‘€ μ½”λ“ μƒμ μ£Όμ„μΌλ΅ μ„¤λ…λμ–΄ μμΌλ―€λ΅ ν•µμ‹¬μ΄λΌ μƒκ°λλ” κ²ƒλ§ κ°„λµν•κ² μ†κ°

- μ΄μ „μ `socket` μ—μ„λ” λ‹¨μν•κ² socket λ§μ„ μƒμ„±ν•κ³ , κ·Έκ²ƒμ μ—­ν• μ€ μ½”λ“λ¥Ό ν†µν•΄ μ§μ ‘ κµ¬ν„ν•΄μ•Όν–λ‹¤.

- ν•μ§€λ§ `zmq` λ¥Ό μ΄μ©ν•λ©΄ λ‹¤μ–‘ν• ν¨ν„΄μ— λ€ν• μ†μΌ“μ„ μƒμ„±ν•  μ μκ³ , μ΄λ―Έ ν•΄λ‹Ή ν¨ν„΄μ—μ„ λ§μ΄ μ‚¬μ©ν•λ” κ²ƒλ“¤μ— λ€ν• λ΅μ§ κµ¬ν„μ΄ μ΄λ―Έ λμ–΄μμ–΄ νΈλ¦¬ν•λ‹¤.

- μ„λ²„, ν΄λΌμ΄μ–ΈνΈ, μ›μ»¤λ“¤ μ‚¬μ΄μ zmq μ†μΌ“ μ‚¬μ© μΆ…λ¥ λ° μ—°κ²° κ΄€κ³„

  ```js
  /* ν΄λΌμ΄μ–ΈνΈ - μ„λ²„ */
  // ν΄λΌμ΄μ–ΈνΈλ” dealer μ†μΌ“μ„ κ°€μ§€κ³ , μ„λ²„μ routerμ™€ ν†µμ‹ ν•λ‹¤.
  var sock = makeASocket("dealer", clientId, frontAddr, "connect"); // ν΄λΌ
  // frontserverλ” router μ†μΌ“μ„ κ°€μ§€κ³ , ν΄λΌμ΄μ–ΈνΈμ dealerμ™€ ν†µμ‹ ν•λ‹¤.
  var frontSvr = makeASocket("router", "front", frontAddr, "bindSync"); // μ„λ²„ front

  /* μ„λ²„ - μ›μ»¤ */
  // backserverλ” dealer μ†μΌ“μ„ κ°€μ§€κ³ , μ›μ»¤λ“¤μ dealerμ™€ ν†µμ‹ ν•λ‹¤.
  var backSvr = makeASocket("dealer", "back", backAddr, "bindSync"); // μ„λ²„ back
  // μ›μ»¤λ” dealer μ†μΌ“μ„ κ°€μ§€κ³ , μ„λ²„μ dealerμ™€ ν†µμ‹ ν•λ‹¤.
  var sock = makeASocket("dealer", "worker#" + workerId, backAddr, "connect"); // μ›μ»¤
  ```

- μ†μΌ“μ— λ€ν•΄ `event listener` λ¥Ό λ§λ“¤κ³ , `event listener` μ— `call back` ν•¨μλ¥Ό κµ¬ν„ν•λ” κ²ƒμ€ μ΄μ „μ `net` λ¨λ“μ„ μ‚¬μ©ν• κµ¬ν„κ³Ό μ μ‚¬ν•λ‹¤.

- dealer-router ν¨ν„΄μ—μ„ μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈ μ†μΌ“μ—μ„ λ³΄λƒλ”μ§€μ— λ€ν• μ •λ³΄ μ—†μ΄ μ„λ²„μ™€ μ›μ»¤κ°€ μ‘μ—…ν•λ‹¤λ©΄, μ„λ²„-μ›μ»¤ μ‚¬μ΄μ—μ„λ” μ¬λ°”λ¥΄κ² λ™μ‘μ„ ν•΄λ„, μ„λ²„ - ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄μ—μ„λ” μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈ μ†μΌ“μ—μ„ λ³΄λƒλ”μ§€ μ• μ μ—†κΈ° λ•λ¬Έμ— λ¬Έμ κ°€ μƒκΈ΄λ‹¤. μ΄ λ•λ¬Έμ— sendλ¥Ό μν–‰ν• λ• `identity` λΌλ” ν•­λ©μ„ μ¶”κ°€ν•΄μ„ λ©”μ‹μ§€λ¥Ό μ£Όκ³  λ°›λ” κ²ƒμ„ λ³Ό μ μλ‹¤.

  ```js
  // μ„λ²„μ™€ μ›μ»¤ μ‚¬μ΄μ λ™μ‘μ— λ€ν•΄μ„ μμ„λ€λ΅ νΈμ¶λλ” κ²ƒμ„ λ‚μ—΄.

  // serverμ router(frontSvr)κ°€ ν΄λΌμ΄μ–ΈνΈμ dealer λ΅λ¶€ν„° λ©”μ‹μ§€λ¥Ό λ°›μ•μ„λ•
  frontSvr.on("message", function () {
    var args = Array.apply(null, arguments); // μ½λ°±ν•¨μμ νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ κ²ƒμ„ λ¨λ‘ μ½μ–΄μ¬ μ μλ‹¤.
    // backSvrλ΅ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•λ‹¤.
    // μ›μ»¤μ™€ μ—°κ²°λμ–΄μλ‹¤.
    backSvr.send(args); // μ •λ³΄λ¥Ό μ μ§€ν•κΈ° μ„ν•΄ λ¨λ“  νλΌλ―Έν„°λ¥Ό λ„κ²¨μ„ λ³΄λ‚Έλ‹¤.
  });

  // μ›μ»¤μ dealerμ—μ„ λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄λ” λ¶€λ¶„.
  sock.on("message", function (identity, data) {
    // μ–΄λ””μ„ λ³΄λƒλ”μ§€ μ •λ³΄λ¥Ό μ μ§€ν•λ©΄μ„ λ°μ΄ν„°λ¥Ό μ£Όκ³ λ°›κΈ° μ„ν•΄ identityλ¥Ό λ„£μ€ λ¨μµμ„ ν™•μΈν•  μ μλ‹¤.
    sock.send([identity, data]);
  });

  // serverμ dealer(backSvr)κ°€ μ›μ»¤μ dealerλ΅ λ¶€ν„° λ©”μ‹μ§€λ¥Ό λ°›μ•μ„ λ•.
  backSvr.on("message", function () {
    var args = Array.apply(null, arguments); // μ½λ°±ν•¨μμ νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ κ²ƒμ„ λ¨λ‘ μ½μ–΄μ¬ μ μλ‹¤.
    // frontSvrλ΅ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•λ‹¤.
    // ν΄λΌμ΄μ–ΈνΈμ™€ μ—°κ²°λμ–΄μλ‹¤.
    frontSvr.send(args); // μ •λ³΄λ¥Ό μ μ§€ν•κΈ° μ„ν•΄ λ¨λ“  νλΌλ―Έν„°λ¥Ό λ„κ²¨μ„ λ³΄λ‚Έλ‹¤.
  });
  ```

  <br>

### λ°λ¨μμƒ μ†κ°

- μ„λ²„ ν”„λ΅κ·Έλ¨μ„ λ™μ‘μ‹ν‚¤κ²λλ©΄, λ™μ‘μ‹ν‚¤λ©΄μ„ λ„κ²¨μ¤€ νλΌλ―Έν„°μ μ«μμ— λ”°λ¥Έ ν”„λ΅μ„Έμ¤κ°€ μƒμ„±λκ³ , κ° ν”„λ΅μ„Έμ¤ μ•μ—μ„ μ›μ»¤κ°€ μ‚΄μ•„λ‚λ‹¤.

- ν΄λΌμ΄μ–ΈνΈ ν”„λ΅κ·Έλ¨μ„ λ™μ‘μ‹ν‚¤κ²λλ©΄, λ™μ‘μ‹ν‚¤λ©΄μ„ λ„κ²¨μ¤€ ν΄λΌμ΄μ–ΈνΈ μ•„μ΄λ””κ°€ ν”„λ΅μ„Έμ¤μ μ†μΌ“ identityλ΅ μ§€μ •ν•λ©΄μ„ μ†μΌ“μ„ μƒμ„±ν•κ³ , ν†µμ‹ μ΄ μ‹μ‘λλ‹¤.

- 1μ κ²½μ° : 1κ°μ μ„λ²„, 1κ°μ μ›μ»¤ 3κ°μ ν΄λΌμ΄μ–ΈνΈ

  - ν΄λΌμ΄μ–ΈνΈλ” dealerλ¥Ό ν†µν•΄ μ„λ²„μ routerμ— λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έλ‹¤.
  - μ„λ²„λ” λ°›μ€ λ©”μ‹μ§€λ¥Ό dealerλ¥Ό ν†µν•΄ μ›μ»¤μ—κ² μ „λ‹¬ν•λ”λ°, μ›μ»¤κ°€ 1κ° λ°–μ— μ—†μΌλ―€λ΅ ν•λ‚μ μ›μ»¤μ—λ§ μ „λ‹¬λμ–΄ worker#1 λ§ λ™μ‘ν•λ” κ²ƒμ„ λ³Ό μ μλ‹¤.
  - μ΄ν›„ μ›μ»¤λ” λ©”μ‹μ§€λ¥Ό λ‹¤μ‹ μ„λ²„μ— λ³΄λ‚΄κ³ , μ„λ²„λ” λ‹¤μ‹ λ©”μ‹μ§€λ¥Ό ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚΄μ¤€λ‹¤. μ΄λ• identityλ¥Ό μ΄μ©ν•΄ λ³΄λƒλ ν΄λΌμ΄μ–ΈνΈλ¥Ό μ°Ύμ•„κ° μ μλ‹¤.

- 2μ κ²½μ° : 1κ°μ μ„λ²„, 4κ°μ μ›μ»¤, 3κ°μ ν΄λΌμ΄μ–ΈνΈ
  - ν΄λΌμ΄μ–ΈνΈλ” dealerλ¥Ό ν†µν•΄ μ„λ²„μ routerμ— λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έλ‹¤.
  - μ„λ²„λ” λ°›μ€ λ©”μ‹μ§€λ¥Ό dealerλ¥Ό ν†µν•΄ μ›μ»¤μ—κ² μ „λ‹¬ν•λ”λ°, 4κ°μ ν”„λ΅μ„Έμ¤ μ„μ—μ„ κ°κ° 1κ°μ”© μ›μ»¤κ°€ λκ³ μμΌλ―€λ΅ μ΄ 4κ°μ μ›μ»¤κ°€ μλ‹¤. μ΄λ• dealerκ°€ μ•μ•„μ„ μ—°κ²°λ μ›μ»¤λ“¤μ„ λ³΄κ³  μΌμ„ λ¶„λ°°ν•΄μ¤€λ‹¤.
  - κ·Έ κ²°κ³Ό μ‹¤ν–‰ν™”λ©΄μ„ λ³΄λ©΄ μ›μ»¤λ“¤μ΄ κ³¨κ³ λ£¨ λ²κ°μ•„κ°€λ©΄μ„ μ‹¤ν–‰λλ” κ²ƒμ„ λ³Ό μ μλ‹¤.
  - μ΄ν›„ μ›μ»¤λ” λ©”μ‹μ§€λ¥Ό λ‹¤μ‹ μ„λ²„μ— λ³΄λ‚΄κ³ , μ„λ²„λ” λ‹¤μ‹ λ©”μ‹μ§€λ¥Ό ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚΄μ¤€λ‹¤. μ΄λ• identityλ¥Ό μ΄μ©ν•΄ λ³΄λƒλ ν΄λΌμ΄μ–ΈνΈλ¥Ό μ°Ύμ•„κ° μ μλ‹¤.

<br>

### λλ‚€μ 

- ν™•μ‹¤ν zmqμ—λ” κ°•λ ¥ν• κΈ°λ¥μ„ νΈλ¦¬ν•κ² μ‚¬μ©ν•  μ μλ„λ΅ λ§λ“¤μ–΄μ§„ ν¨ν„΄μ΄ λ§μ•„ μΆ‹λ‹¤λ” μƒκ°μ΄ λ“¤μ—λ‹¤.

- μ΄κ²ƒμ„ μ΄μ©ν•λ©΄ μΌμ„ λ¶„μ‚°ν•΄μ„ μ²λ¦¬ν•λ” μ„λ²„λ¥Ό κµ¬μ„±ν•λ”λ° μΆ‹μ„κ²ƒμ΄λΌ λκΌλ‹¤.

<br/>

---

#### π› κµ¬ν„ν• μ½”λ“μ λ‚΄μ©μ— λ€ν• μμ„Έν• μ„¤λ…μ€ js νμΌ μ•μ— μ£Όμ„μΌλ΅ μ²¨λ¶€λμ–΄μμµλ‹λ‹¤.

#### π λ”°λΌμ„ ν•µμ‹¬μ΄λΌ μƒκ°λλ” μ½”λ“λ¥Ό μ μ™Έν• λ‚λ¨Έμ§€ μ½”λ“μ— λ€ν• μμ„Έν• λ‚΄μ©μ€ ν•΄λ‹Ή readmeμ—μ„ μ μ™Έν•μ€μµλ‹λ‹¤.
