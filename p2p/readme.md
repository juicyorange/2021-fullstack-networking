## 12. ZMQ DIRTY P2P

<br>

### κ°λ° κ²°κ³Όλ¬Ό

- node.jsμ `zeromq` λ¨λ“μ„ μ‚¬μ©ν•μ—¬ zmqλ¥Ό μ‚¬μ©ν•΄λ³Έλ‹¤.

- μ§€κΈκΉμ§€ λ°°μ› λ sub-pub ν¨ν„΄, pull-pushν¨ν„΄, req-rep ν¨ν„΄μ„ ν™μ©ν•μ—¬ p2p ν”„λ΅κ·Έλ¨μ„ λ§λ“¤μ–΄λ³Έλ‹¤.

- μ„λ²„μ μ—­ν• μ„ ν•λ” ν”„λ΅κ·Έλ¨μ„ μ°Ύμ§€ λ»ν•μ€λ‹¤λ©΄ μμ‹ μ΄ μ„λ²„μ μ—­ν• λ„ μν–‰ν•κ² λλ‹¤.

- ν•µμ‹¬ κΈ°λ¥

  - μν–‰λκ³  μλ” nameserverκ°€ μλ”μ§€ ν™•μΈν•λ” `searchNameServer` ν•¨μ
  - μ„λ²„μ μ—­ν• μ„ ν•κ² λμ—μ„λ• μ£Όλ³€μ— μ„λ²„κ°€ μλ‹¤λ” κ²ƒμ„ μ•λ¦¬λ” μ—­ν• μ„ ν•λ” λΉ„μ½ μ„λ²„ `beaconNameserver`
  - μ μ €λ¥Ό λ“±λ΅ν•΄μ£Όλ” λ“±μ μ μ €λ¥Ό κ΄€λ¦¬ν•΄μ£Όλ” μ—­ν• μ„ ν•λ μ μ € κ΄€λ¦¬ μ„λ²„ `userManagerNameserver`
  - λ§μ§€λ§‰μΌλ΅ μ μ €λ“¤μ΄ μ •λ³΄λ¥Ό λ³΄λƒμ„λ•, κ·Έ μ •λ³΄λ¥Ό λ‹¤λ¥Έ λ¨λ“  μ μ €λ“¤μ—κ² μ „λ‹¬ν•΄μ£Όλ” λ¦΄λ μ΄ μ„λ²„ `relayServerNameServer`

- μ„μ ν•µμ‹¬ κΈ°λ¥μ„ λ°”νƒ•μΌλ΅ μ„λ²„ν”„λ΅κ·Έλ¨μ„ λ”°λ΅ λ™μ‘μ‹ν‚¬ ν•„μ” μ—†μ΄ μ„λ²„κ°€ μ—†λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ—­ν• λ„ ν•λ”, νΉμ • μ„λ²„ μ—†μ΄ λ™μ‘ν•λ” p2p ν†µμ‹ μ„ κµ¬ν„ν•λ‹¤.

<br>

### μ†μ¤μ½”λ“ μ†κ°

π‘€ μ½”λ“ μƒμ μ£Όμ„μΌλ΅ μ„¤λ…λμ–΄ μμΌλ―€λ΅ ν•µμ‹¬μ΄λΌ μƒκ°λλ” κ²ƒλ§ κ°„λµν•κ² μ†κ°

- μ΄μ „μ `socket` μ—μ„λ” λ‹¨μν•κ² socket λ§μ„ μƒμ„±ν•κ³ , κ·Έκ²ƒμ μ—­ν• μ€ μ½”λ“λ¥Ό ν†µν•΄ μ§μ ‘ κµ¬ν„ν•΄μ•Όν–λ‹¤.

- ν•μ§€λ§ `zmq` λ¥Ό μ΄μ©ν•λ©΄ λ‹¤μ–‘ν• ν¨ν„΄μ— λ€ν• μ†μΌ“μ„ μƒμ„±ν•  μ μκ³ , μ΄λ―Έ ν•΄λ‹Ή ν¨ν„΄μ—μ„ λ§μ΄ μ‚¬μ©ν•λ” κ²ƒλ“¤μ— λ€ν• λ΅μ§ κµ¬ν„μ΄ μ΄λ―Έ λμ–΄μμ–΄ νΈλ¦¬ν•λ‹¤.

- μ†μ¤μ½”λ“λ” μ£Όμ”ν• λ™μ‘μΈ μ„λ²„κ°€ μ‚΄μ•„μλ”μ§€ ν™•μΈν•λ” μ½”λ“μ— λ€ν•΄ μ†κ°ν•κ³ μ ν•λ‹¤.

  ```js
  /* λΉ„μ½ μ„λ²„ */
  // μ£Όλ³€μ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μ„λ²„κ°€ μμμ„ μ•λ ¤μ•Όν•κΈ° λ•λ¬Έμ— pubλ¥Ό μ‚¬μ©ν•λ‹¤.
  let publisher = zmq.socket("pub");
  publisher.bindSync("tcp://" + localIpAddress + ":" + portNameserver);

   // beaconNameserverλ” μ£Όλ³€μ— κ³„μ†ν•΄μ„ λ„¤μ„μ„λ²„κ°€ λ™μ‘ν•κ³  μμμ„ pubλ¥Ό ν†µν•΄ μ•λ¦°λ‹¤.
  // μ΄λ–„ 1μ΄μ— ν•λ²μ”© publishλ¥Ό ν†µν•΄ subscriberλ“¤μ—κ² λ©”μ‹μ§€λ¥Ό λΏλ¦°λ‹¤.
  const sendBeaconMessage = () => {
    // 1μ΄ λ’¤μ— μ½λ°±ν•¨μκ°€ μν–‰λλ‹¤.
    setTimeout(() => {
      let msg = "NAMESERVER:" + localIpAddress;
      // λ©”μ‹μ§€ publish
      publisher.send(msg.toString());
      sendBeaconMessage();
    }, 1000);
  };
  sendBeaconMessage();
  };

  /* searchNameserver */
  // νΉμ • μ£Όμ†μ— μ„μΉν•  κ²ƒμ΄λΌ μƒκ°λλ” λΉ„μ½μ„λ²„μ— connect(subscribe)ν•κ³ ,
  // λΉ„μ½μ„λ²„κ°€ publish ν•λ” μ¥λ³΄λ¥Ό λ°›κΈ°μ„ν•΄ sub μ‚¬μ©.
  let subscriber = zmq.socket("sub");

  // λ°λ³µλ¬Έμ„ λλ©΄μ„ 255κ°μ μ£Όμ†μ— connect(subscribe)λ¥Ό ν•΄λ³Έλ‹¤.
  for (last; last < 256; last++) {
    let targetIpAddr = "tcp://" + ipMask + "." + last + ":" + portNameserver;

    if (targetIpAddr !== localIpAddress || targetIpAddr === localIpAddress) {
      // targetIpAddrμ— μ—°κ²°μ„ μ”μ²­ν•΄λ³Έλ‹¤.
      // μ—°κ²°μ”μ²­ν•λ” targetIpAddrμ€ μ„μ λΉ„μ½μ„λ²„μ—μ„ bindν• μ†μΌ“μ μ£Όμ†μ™€ λ™μΌν•λ‹¤.
      subscriber.connect(targetIpAddr);
    }
  }

  // μ—°κ²°λ μ†μΌ“μ—μ„ λ©”μ‹μ§€κ°€ μ¨κ²ƒμ„ κ°μ§€ν•λ” event listnerκ°€ μν–‰λμ–΄ μ½λ°±ν•¨μκ°€ μν–‰λ κ²ƒμ€
  // λΉ„μ½ μ„λ²„λ΅λ¶€ν„° λ©”μ‹μ§€κ°€ λ‚ λΌμ¨ κ²ƒμΌλ΅, μ„λ²„κ°€ μ΅΄μ¬ν•λ‹¤ λ³Ό μμλ‹¤.
  // κ·Έλ¬λ©΄ λ¦¬ν„΄ν• κ²°κ³Όλ¥Ό λ³΄κ³  ν΄λΌμ΄μ–ΈνΈμ μ—­ν• λ§ μν–‰ν•λ„λ΅ ν•λ©΄ λλ‹¤.
  subscriber.once("message", async (msg) => {
    resolve(msg)
  });

  // κ·Έλ ‡μ§€ μ•κ³  μΌμ •μ‹κ°„λ™μ• λ©”μ‹μ§€κ°€ μ¤μ§€ μ•μΌλ©΄ λΉ„μ½μ„λ²„κ°€ μ—†λ” κ²ƒμΌλ΅ κ°„μ£Όν•κ³ ,
  // ν•΄λ‹Ή ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„ μ—­ν• μ„ μν–‰ν•λ„λ΅ ν•λ” λ΅μ§μ„ μν–‰ν•λ‹¤.
  const timeout = setTimeout(() => {
    resolve(null);
  }, 1000);
  ```

      <br>

### λ°λ¨μμƒ μ†κ°

- μ°μ„  μ²μ ν΄λΌμ΄μ–ΈνΈλ¥Ό μΌκ²λλ©΄ 255κ°μ μ£Όμ†λ¥Ό μ—°κ²°ν•΄λ³΄λ©΄μ„ μ„λ²„κ°€ μλ”μ§€ ν™•μΈν•΄λ³΄κ² λλ‹¤.

- p2p μ„λ²„μ μ—­ν• μ„ ν•λ” κ²ƒμ΄ μ—†μμ„ μ•κ²λκ³ , μκΈ° μμ‹ μ΄ p2pμ„λ²„ μ—­ν• μ„ ν•κΈ° μ„ν•΄ nameserver, beaconserver, relayserverλ¥Ό μƒμ„±ν•λ‹¤.

- μ΄ν›„ μκΈ° μμ‹ λ„ userλ΅ λ“±λ΅ν•μ—¬ p2p μ„λ²„λ¥Ό μ‚¬μ©ν•λ‹¤. on, off λ©”μ‹μ§€λ¥Ό μ£Όκ³  λ°›λ” κ²ƒμ„ λ³Ό μ μλ‹¤.

- μ΄ν›„ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ λ“¤μ–΄μ¤λ©΄ λ§μ°¬κ°€μ§€λ΅ 255κ°μ μ£Όμ†λ¥Ό μ—°κ²°ν•΄λ³΄λ©΄μ„ μ„λ²„κ°€ μλ”μ§€ ν™•μΈν•΄λ³΄κ² λλ‹¤.

- μ΄λ•λ” μ„λ²„μ μ—­ν• μ„ ν•λ” κ²ƒμ΄ μμΌλ―€λ΅ λ°”λ΅ userλ΅ λ“±λ΅ν•κ³  p2p μ„λ²„λ¥Ό μ‚¬μ©ν•λ‹¤. on, off λ©”μ‹μ§€λ¥Ό μ£Όκ³ λ°›λ” κ²ƒμ„ λ³Ό μ μλ‹¤.

<br>

### λλ‚€μ 

- zmqμ—μ„ λ°°μ› λ κ²ƒμ„ λ¨λ‘ λ‹¤ μ‚¬μ©ν• κ²ƒμΌλ΅ ν™•μ‹¤ν κµ¬ν„ν•λ”λ° μ–΄λ ¤μ› κ³ , κ·Έλ§νΌ λ§μ΄ λ°°μ› λ‹¤ μƒκ°ν•λ‹¤.

- p2p μ„λ²„κ°€ μ–΄λ–»κ² λ™μ‘ν•λ”μ§€ μ‹¤μ λ΅ κµ¬ν„ν•΄λ³΄λ©΄μ„ μ• μ μλ” μΆ‹μ€ κ²½ν—μ΄μ—λ‹¤ μƒκ°ν•λ‹¤.

<br/>

---

#### π› κµ¬ν„ν• μ½”λ“μ λ‚΄μ©μ— λ€ν• μμ„Έν• μ„¤λ…μ€ js νμΌ μ•μ— μ£Όμ„μΌλ΅ μ²¨λ¶€λμ–΄μμµλ‹λ‹¤.

#### π λ”°λΌμ„ ν•µμ‹¬μ΄λΌ μƒκ°λλ” μ½”λ“λ¥Ό μ μ™Έν• λ‚λ¨Έμ§€ μ½”λ“μ— λ€ν• μμ„Έν• λ‚΄μ©μ€ ν•΄λ‹Ή readmeμ—μ„ μ μ™Έν•μ€μµλ‹λ‹¤.
